---
phase: 10-progress-indication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - mlpstorage/progress.py
  - tests/unit/test_progress.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Rich is an explicit dependency in pyproject.toml"
    - "progress_context() detects interactive vs non-interactive terminals"
    - "Non-interactive mode logs status messages instead of animations"
    - "Spinners work for indeterminate progress"
    - "Progress bars work for determinate progress with percentage"
  artifacts:
    - path: "pyproject.toml"
      provides: "Rich dependency declaration"
      contains: "rich>=13.0"
    - path: "mlpstorage/progress.py"
      provides: "Progress indication utilities"
      exports: ["progress_context", "is_interactive_terminal", "create_stage_progress"]
      min_lines: 80
    - path: "tests/unit/test_progress.py"
      provides: "Unit tests for progress module"
      min_lines: 60
  key_links:
    - from: "mlpstorage/progress.py"
      to: "rich.progress"
      via: "import"
      pattern: "from rich\\.progress import"
    - from: "mlpstorage/progress.py"
      to: "rich.console"
      via: "import"
      pattern: "from rich\\.console import Console"
---

<objective>
Create progress indication utilities using Rich library with automatic TTY detection.

Purpose: Provides foundational progress utilities that all benchmark operations will use for consistent progress feedback. TTY detection ensures progress works correctly in both interactive terminals and CI/logs.

Output: `mlpstorage/progress.py` module with context managers for progress indication, `pyproject.toml` updated with Rich dependency, comprehensive unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-progress-indication/10-RESEARCH.md
@mlpstorage/mlps_logging.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Rich dependency and create progress module</name>
  <files>pyproject.toml, mlpstorage/progress.py</files>
  <action>
1. Update pyproject.toml dependencies:
   - Add "rich>=13.0" to the dependencies list with comment "# Progress indication (UX-04)"
   - Rich is already a transitive dependency (v14.2.0) but make it explicit for direct usage

2. Create mlpstorage/progress.py with these components:

   a) is_interactive_terminal() function:
      - Uses Console().is_terminal for TTY detection
      - Returns bool

   b) progress_context() context manager:
      - Parameters: description (str), total (Optional[int]), logger (Optional), transient (bool=True)
      - If not interactive: log via logger.status() if logger provided, yield no-op callables
      - If interactive: create Rich Progress with appropriate columns
        - For indeterminate (total=None): SpinnerColumn, TextColumn, TimeElapsedColumn
        - For determinate (total set): SpinnerColumn, TextColumn, BarColumn, percentage, TimeElapsedColumn, TimeRemainingColumn
      - Yield tuple of (update_func, set_description_func)
      - update_func(advance=1, completed=None): Updates progress
      - set_description_func(desc): Updates description text

   c) create_stage_progress() context manager:
      - For multi-stage operations (validating -> collecting -> running -> processing)
      - Parameters: stages (List[str]), logger (Optional), transient (bool=True)
      - If not interactive: log each stage via logger.status()
      - If interactive: show progress bar through stages
      - Yield advance_stage(stage_name=None) function

   Use these imports from Rich:
   - from rich.console import Console
   - from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TimeElapsedColumn, TimeRemainingColumn, TaskID

   Ensure all progress operations are properly cleaned up via context manager __exit__.
  </action>
  <verify>python -c "from mlpstorage.progress import progress_context, is_interactive_terminal, create_stage_progress; print('Import OK')"</verify>
  <done>progress.py exists with is_interactive_terminal(), progress_context(), create_stage_progress() exported, Rich in pyproject.toml</done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for progress module</name>
  <files>tests/unit/test_progress.py</files>
  <action>
Create comprehensive unit tests for progress module following existing test patterns in test_benchmarks_base.py.

Test coverage:

1. test_is_interactive_terminal_returns_bool:
   - Verify function returns boolean
   - Mock Console.is_terminal to test both True and False cases

2. test_progress_context_non_interactive_logs_status:
   - Mock Console.is_terminal = False
   - Provide mock logger
   - Verify logger.status() called with description
   - Verify yielded functions are no-ops (can be called without error)

3. test_progress_context_non_interactive_no_logger:
   - Mock Console.is_terminal = False
   - No logger provided
   - Verify no error raised, no-op functions work

4. test_progress_context_interactive_creates_progress:
   - Mock Console.is_terminal = True
   - Patch Rich Progress class
   - Verify Progress created with appropriate columns for indeterminate (total=None)
   - Verify start() and stop() called

5. test_progress_context_determinate_has_bar:
   - Mock Console.is_terminal = True
   - total=100
   - Verify BarColumn and TimeRemainingColumn included

6. test_progress_context_update_advances:
   - Interactive mode
   - Call update(advance=5)
   - Verify progress.update() called with advance=5

7. test_progress_context_set_description_updates:
   - Interactive mode
   - Call set_description("New desc")
   - Verify progress.update() called with description="New desc"

8. test_create_stage_progress_non_interactive_logs_stages:
   - Mock non-interactive
   - stages = ["Stage 1", "Stage 2", "Stage 3"]
   - Call advance_stage() twice
   - Verify logger.status() called for each stage

9. test_create_stage_progress_interactive_advances:
   - Mock interactive
   - Verify Progress created with total=len(stages)
   - Call advance_stage()
   - Verify progress.update() called with advance=1

10. test_progress_context_exception_cleanup:
    - Verify progress.stop() called even when exception raised inside context

Use pytest fixtures for mock logger and mock Console.
  </action>
  <verify>pytest tests/unit/test_progress.py -v</verify>
  <done>All tests pass, testing TTY detection, interactive/non-interactive modes, update/advance functions, cleanup on exception</done>
</task>

</tasks>

<verification>
1. Rich dependency in pyproject.toml: `grep "rich" pyproject.toml`
2. Progress module imports: `python -c "from mlpstorage.progress import progress_context, is_interactive_terminal, create_stage_progress"`
3. Tests pass: `pytest tests/unit/test_progress.py -v`
4. No regressions: `pytest tests/unit -v --ignore=tests/unit/test_rules_calculations.py --ignore=tests/unit/test_reporting.py`
</verification>

<success_criteria>
1. Rich>=13.0 explicitly listed in pyproject.toml dependencies
2. mlpstorage/progress.py exports progress_context, is_interactive_terminal, create_stage_progress
3. progress_context detects TTY and uses Rich or logger fallback appropriately
4. All unit tests pass (10+ tests covering core functionality)
5. Existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-progress-indication/10-01-SUMMARY.md`
</output>
