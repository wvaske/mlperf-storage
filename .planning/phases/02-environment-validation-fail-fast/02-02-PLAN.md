---
phase: 02-environment-validation-fail-fast
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - mlpstorage/dependency_check.py
  - mlpstorage/error_messages.py
  - tests/unit/test_dependency_check.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "MPI missing error includes OS-specific install command"
    - "DLIO missing error includes pip install command"
    - "SSH missing error includes OS-specific install command"
    - "Error messages are copy-pasteable"
  artifacts:
    - path: "mlpstorage/dependency_check.py"
      provides: "Enhanced dependency checking with OS hints"
      exports: ["check_mpi_with_hints", "check_dlio_with_hints", "check_ssh_available"]
    - path: "mlpstorage/error_messages.py"
      provides: "New error message templates"
      contains: "DEPENDENCY_MPI_MISSING"
  key_links:
    - from: "mlpstorage/dependency_check.py"
      to: "mlpstorage/environment"
      via: "import for OS detection"
      pattern: "from mlpstorage.environment import"
---

<objective>
Extend dependency_check.py with OS-aware error messages.

Purpose: When users are missing MPI, DLIO, or SSH, they see specific installation commands for their operating system that they can copy-paste.

Output: Enhanced dependency checking functions with OS-specific suggestions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-environment-validation-fail-fast/02-RESEARCH.md
@mlpstorage/dependency_check.py
@mlpstorage/error_messages.py
@mlpstorage/errors.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enhanced dependency check functions</name>
  <files>mlpstorage/dependency_check.py</files>
  <action>
Add OS-aware dependency checking functions that use the environment module:

1. Add import at top: `from mlpstorage.environment import detect_os, get_install_instruction`

2. Add `check_mpi_with_hints(mpi_bin: str = "mpirun") -> str`:
   - Call `shutil.which(mpi_bin)` first
   - If found, return path
   - If not found: detect OS, get install instruction, raise DependencyError with OS-specific suggestion
   - Format suggestion as multi-line with clear install command

3. Add `check_dlio_with_hints(dlio_bin_path: Optional[str] = None) -> str`:
   - Similar pattern to existing `check_dlio_available`
   - Include both `pip install -e '.[full]'` and `pip install dlio-benchmark` options
   - If dlio_bin_path specified, check that path specifically

4. Add `check_ssh_available() -> str`:
   - Check for `ssh` executable in PATH
   - If not found: detect OS, get install instruction, raise DependencyError
   - Include note about SSH being required for distributed benchmarks

5. Keep existing functions for backward compatibility, but have them call the new versions internally OR keep parallel implementations.

Note: Use the existing DependencyError class from mlpstorage.errors.
  </action>
  <verify>
```python
from mlpstorage.dependency_check import check_mpi_with_hints, check_ssh_available
import shutil
# Test that functions exist and work when deps are present
if shutil.which('ssh'):
    path = check_ssh_available()
    print(f"SSH found at: {path}")
```
  </verify>
  <done>
check_mpi_with_hints, check_dlio_with_hints, and check_ssh_available functions exist. When dependencies are missing, they raise DependencyError with OS-specific installation commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add error message templates</name>
  <files>mlpstorage/error_messages.py</files>
  <action>
Add new error message templates to ERROR_MESSAGES dict:

1. `DEPENDENCY_MPI_MISSING`:
   - Multi-line message explaining MPI is required for distributed benchmarks
   - Placeholder for {install_cmd}
   - Note about ensuring MPI is in PATH after install

2. `DEPENDENCY_DLIO_MISSING`:
   - Multi-line message explaining DLIO is the benchmark engine
   - Include both pip install options
   - Note about verifying installation

3. `DEPENDENCY_SSH_MISSING`:
   - Message explaining SSH is required for distributed runs
   - Placeholder for {install_cmd}
   - Note about configuring passwordless SSH

4. `ENVIRONMENT_VALIDATION_SUMMARY`:
   - Template for reporting multiple validation errors
   - Placeholder for {error_count} and {error_list}

These templates should be detailed and actionable, following the pattern of existing templates like 'MPI_NOT_AVAILABLE'.
  </action>
  <verify>
```python
from mlpstorage.error_messages import ERROR_MESSAGES, format_error
assert 'DEPENDENCY_MPI_MISSING' in ERROR_MESSAGES
assert 'DEPENDENCY_DLIO_MISSING' in ERROR_MESSAGES
assert 'DEPENDENCY_SSH_MISSING' in ERROR_MESSAGES
msg = format_error('DEPENDENCY_MPI_MISSING', install_cmd='sudo apt-get install openmpi-bin')
assert 'apt-get' in msg
```
  </verify>
  <done>
New error message templates added. Templates include placeholders for OS-specific install commands and are formatted for readability.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend dependency check tests</name>
  <files>tests/unit/test_dependency_check.py</files>
  <action>
Add tests for the new OS-aware dependency check functions:

1. TestCheckMpiWithHints class:
   - Test finds mpirun when available (mock shutil.which returning path)
   - Test raises DependencyError when missing (mock shutil.which returning None)
   - Test error message contains OS-specific install command (mock detect_os for Ubuntu)
   - Test error message contains OS-specific install command (mock detect_os for macOS)

2. TestCheckDlioWithHints class:
   - Test finds dlio_benchmark in PATH
   - Test finds dlio_benchmark in custom path
   - Test raises DependencyError with pip install suggestion when missing

3. TestCheckSshAvailable class:
   - Test finds ssh when available
   - Test raises DependencyError when missing
   - Test error includes install suggestion

Use mocking patterns from existing tests. Mock both shutil.which and mlpstorage.environment.detect_os.
  </action>
  <verify>pytest tests/unit/test_dependency_check.py -v</verify>
  <done>
All dependency_check tests pass, including new tests for OS-aware functions. Tests verify that error messages contain appropriate OS-specific install commands.
  </done>
</task>

</tasks>

<verification>
```bash
# Run all dependency check tests
pytest tests/unit/test_dependency_check.py -v

# Quick smoke test
python -c "
from mlpstorage.dependency_check import check_mpi_with_hints
from mlpstorage.errors import DependencyError
try:
    check_mpi_with_hints('definitely_not_mpi')
except DependencyError as e:
    print('Error raised correctly:')
    print(str(e)[:200])
"
```
</verification>

<success_criteria>
1. check_mpi_with_hints, check_dlio_with_hints, check_ssh_available exist in dependency_check.py
2. Functions raise DependencyError with OS-specific install commands when deps missing
3. New error templates exist in error_messages.py
4. All tests pass (pytest tests/unit/test_dependency_check.py)
5. Error messages are multi-line, readable, and include copy-pasteable commands
</success_criteria>

<output>
After completion, create `.planning/phases/02-environment-validation-fail-fast/02-02-SUMMARY.md`
</output>
