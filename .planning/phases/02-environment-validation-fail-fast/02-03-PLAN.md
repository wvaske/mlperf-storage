---
phase: 02-environment-validation-fail-fast
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - mlpstorage/environment/validators.py
  - mlpstorage/environment/__init__.py
  - tests/unit/test_environment.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SSH connectivity check returns success/failure per host"
    - "SSH check uses BatchMode to avoid password prompts"
    - "Localhost is skipped in SSH checks"
    - "All validation errors are collected before raising"
  artifacts:
    - path: "mlpstorage/environment/validators.py"
      provides: "SSH connectivity and validation collection"
      exports: ["validate_ssh_connectivity", "ValidationIssue", "collect_validation_issues"]
    - path: "mlpstorage/environment/__init__.py"
      provides: "Module exports"
      exports: ["validate_ssh_connectivity", "ValidationIssue"]
  key_links:
    - from: "mlpstorage/environment/validators.py"
      to: "subprocess"
      via: "SSH command execution"
      pattern: "subprocess.run"
---

<objective>
Create validation functions for SSH connectivity and issue collection.

Purpose: Before running distributed benchmarks, validate that all remote hosts are reachable via SSH. Collect all validation issues together rather than failing on the first one.

Output: SSH validation functions and ValidationIssue data class for collecting multiple errors.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-environment-validation-fail-fast/02-RESEARCH.md
@mlpstorage/validation_helpers.py
@mlpstorage/errors.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ValidationIssue dataclass and validators module</name>
  <files>mlpstorage/environment/validators.py, mlpstorage/environment/__init__.py</files>
  <action>
Create `validators.py` with:

1. `ValidationIssue` dataclass:
   - severity: str ('error' or 'warning')
   - category: str ('dependency', 'configuration', 'connectivity', 'filesystem')
   - message: str (what went wrong)
   - suggestion: str (how to fix it)
   - install_cmd: Optional[str] (copy-pasteable command if applicable)
   - host: Optional[str] (for host-specific issues)

2. `validate_ssh_connectivity(hosts: List[str], timeout: int = 5) -> List[Tuple[str, bool, str]]`:
   - For each host in hosts:
     - Parse host:slots format (take hostname only)
     - Skip localhost and 127.0.0.1
     - Run: `ssh -o BatchMode=yes -o ConnectTimeout={timeout} -o StrictHostKeyChecking=accept-new {hostname} echo ok`
     - Capture result (success/failure and error message)
   - Return list of (hostname, success, message) tuples
   - Handle subprocess.TimeoutExpired and FileNotFoundError (ssh not installed)

3. `collect_validation_issues(issues: List[ValidationIssue]) -> Tuple[List[ValidationIssue], List[ValidationIssue]]`:
   - Separate issues into errors and warnings
   - Return (errors, warnings) tuple

4. Update `__init__.py` to export: `validate_ssh_connectivity`, `ValidationIssue`, `collect_validation_issues`

Note: This is infrastructure that will be used by the comprehensive validator in the next plan.
  </action>
  <verify>
```python
from mlpstorage.environment import ValidationIssue, validate_ssh_connectivity
# Test ValidationIssue
issue = ValidationIssue(severity='error', category='connectivity', message='Host unreachable', suggestion='Check network')
assert issue.severity == 'error'
# Test SSH validation with localhost (should skip)
results = validate_ssh_connectivity(['localhost'])
assert len(results) == 1
assert results[0][0] == 'localhost'
assert results[0][1] == True  # localhost is auto-success
```
  </verify>
  <done>
ValidationIssue dataclass exists. validate_ssh_connectivity correctly tests SSH to remote hosts using BatchMode, skips localhost, and returns structured results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for validators</name>
  <files>tests/unit/test_environment.py</files>
  <action>
Extend tests/unit/test_environment.py with validator tests:

1. TestValidationIssue class:
   - Test dataclass creation with all fields
   - Test dataclass creation with optional fields as None
   - Test severity values ('error', 'warning')
   - Test category values

2. TestValidateSshConnectivity class:
   - Test skips localhost (returns success without running ssh)
   - Test skips 127.0.0.1 (returns success without running ssh)
   - Test parses host:slots format correctly (mock subprocess)
   - Test returns failure when host unreachable (mock subprocess returning non-zero)
   - Test returns failure message from stderr (mock subprocess)
   - Test handles subprocess.TimeoutExpired (returns timeout message)
   - Test handles FileNotFoundError when ssh not installed (returns helpful message)
   - Test returns success for reachable host (mock subprocess returning 0)

3. TestCollectValidationIssues class:
   - Test separates errors from warnings correctly
   - Test handles empty list
   - Test handles all errors
   - Test handles all warnings
   - Test handles mixed errors and warnings

Use subprocess mocking patterns from existing tests.
  </action>
  <verify>pytest tests/unit/test_environment.py -v -k "validator or Validation or ssh"</verify>
  <done>
All validator tests pass. Tests cover ValidationIssue creation, SSH connectivity validation with various mock scenarios, and issue collection/separation.
  </done>
</task>

</tasks>

<verification>
```bash
# Run validator-related tests
pytest tests/unit/test_environment.py -v

# Quick integration test
python -c "
from mlpstorage.environment import ValidationIssue, validate_ssh_connectivity, collect_validation_issues
# Test ValidationIssue
issue = ValidationIssue('error', 'connectivity', 'Test', 'Fix it')
print(f'Issue: {issue}')
# Test localhost skip
results = validate_ssh_connectivity(['localhost', '127.0.0.1'])
print(f'SSH results: {results}')
"
```
</verification>

<success_criteria>
1. ValidationIssue dataclass exists with all required fields
2. validate_ssh_connectivity works and skips localhost
3. collect_validation_issues correctly separates errors from warnings
4. All tests pass (pytest tests/unit/test_environment.py)
5. SSH validation uses BatchMode to avoid password prompts
</success_criteria>

<output>
After completion, create `.planning/phases/02-environment-validation-fail-fast/02-03-SUMMARY.md`
</output>
