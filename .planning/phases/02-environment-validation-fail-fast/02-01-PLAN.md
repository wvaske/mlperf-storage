---
phase: 02-environment-validation-fail-fast
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mlpstorage/environment/__init__.py
  - mlpstorage/environment/os_detect.py
  - mlpstorage/environment/install_hints.py
  - tests/unit/test_environment.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "OS detection returns system type (Linux, Darwin, Windows)"
    - "Linux distro is detected (ubuntu, rhel, debian, etc.)"
    - "Install hints vary by detected OS"
    - "Missing distro package falls back gracefully"
  artifacts:
    - path: "mlpstorage/environment/__init__.py"
      provides: "Module exports"
      exports: ["detect_os", "get_install_instruction"]
    - path: "mlpstorage/environment/os_detect.py"
      provides: "OS and distro detection"
      exports: ["detect_os", "OSInfo"]
    - path: "mlpstorage/environment/install_hints.py"
      provides: "OS-specific install commands"
      exports: ["get_install_instruction", "INSTALL_INSTRUCTIONS"]
    - path: "tests/unit/test_environment.py"
      provides: "Unit tests for environment module"
      min_lines: 50
  key_links:
    - from: "mlpstorage/environment/install_hints.py"
      to: "mlpstorage/environment/os_detect.py"
      via: "uses OSInfo for lookup"
      pattern: "OSInfo|os_info"
---

<objective>
Create the environment detection module with OS-aware install instructions.

Purpose: Enable actionable error messages that tell users exactly how to install missing dependencies on their specific OS (Ubuntu apt-get, RHEL dnf, macOS brew).

Output: New `mlpstorage/environment/` module with OS detection and install hint lookup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-environment-validation-fail-fast/02-RESEARCH.md
@mlpstorage/errors.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OS detection module</name>
  <files>mlpstorage/environment/__init__.py, mlpstorage/environment/os_detect.py</files>
  <action>
Create the `mlpstorage/environment/` package:

1. Create `os_detect.py` with:
   - `OSInfo` dataclass: system (Linux/Darwin/Windows), release, machine, distro_id, distro_name, distro_version
   - `detect_os() -> OSInfo` function:
     - Use `platform.system()` for OS type
     - Use `platform.release()` and `platform.machine()` for details
     - For Linux: Try `distro` package first, fall back to `platform.freedesktop_os_release()` (Python 3.10+)
     - Handle ImportError for distro package gracefully
     - Return OSInfo instance

2. Create `__init__.py` exporting: `detect_os`, `OSInfo`, `get_install_instruction`

Follow existing code patterns from mlpstorage for dataclass style and import conventions.
  </action>
  <verify>
```python
from mlpstorage.environment import detect_os, OSInfo
info = detect_os()
assert isinstance(info, OSInfo)
assert info.system in ('Linux', 'Darwin', 'Windows')
```
  </verify>
  <done>
OSInfo dataclass and detect_os() function work correctly on current system, returning valid OS information with graceful fallback when distro package is unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create install hints module</name>
  <files>mlpstorage/environment/install_hints.py, mlpstorage/environment/__init__.py</files>
  <action>
Create `install_hints.py` with OS-specific installation instructions:

1. Define `INSTALL_INSTRUCTIONS` dictionary mapping (dependency, system, distro_id) tuples to install commands:
   - MPI: Ubuntu/Debian (apt-get), RHEL/CentOS/Fedora (dnf/yum), Arch (pacman), macOS (brew), generic Linux, Windows (MS-MPI link)
   - SSH: Ubuntu (openssh-client), RHEL (openssh-clients), macOS (built-in note)
   - DLIO: Generic pip install commands (OS-independent)

2. Create `get_install_instruction(dependency: str, os_info: OSInfo) -> str`:
   - Look up in order: (dep, system, distro), (dep, system, None), (dep, None, None)
   - Return most specific match or generic fallback message

3. Update `__init__.py` to export `get_install_instruction` and `INSTALL_INSTRUCTIONS`

Dependencies covered: mpi, ssh, dlio
  </action>
  <verify>
```python
from mlpstorage.environment import get_install_instruction, OSInfo
# Test Ubuntu MPI
ubuntu = OSInfo(system='Linux', release='', machine='x86_64', distro_id='ubuntu', distro_name='Ubuntu', distro_version='22.04')
hint = get_install_instruction('mpi', ubuntu)
assert 'apt-get' in hint
# Test macOS MPI
macos = OSInfo(system='Darwin', release='', machine='x86_64', distro_id=None, distro_name=None, distro_version=None)
hint = get_install_instruction('mpi', macos)
assert 'brew' in hint
```
  </verify>
  <done>
get_install_instruction returns OS-specific commands: apt-get for Ubuntu, dnf for RHEL, brew for macOS, with graceful fallback for unknown systems.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for environment module</name>
  <files>tests/unit/test_environment.py</files>
  <action>
Create comprehensive tests following existing test patterns in tests/unit/:

1. TestOSInfo class:
   - Test dataclass creation and field access
   - Test default values for optional fields

2. TestDetectOS class:
   - Test with mocked platform module values
   - Test with distro package available (mocked)
   - Test fallback when distro package unavailable
   - Test on Linux, Darwin, Windows (mocked)

3. TestGetInstallInstruction class:
   - Test Ubuntu gets apt-get command for mpi
   - Test RHEL gets dnf command for mpi
   - Test Debian gets apt-get command for mpi
   - Test macOS gets brew command for mpi
   - Test unknown distro gets generic Linux fallback
   - Test dlio returns pip command regardless of OS
   - Test unknown dependency returns generic message

Use unittest.mock.patch to mock platform and distro modules.
  </action>
  <verify>pytest tests/unit/test_environment.py -v</verify>
  <done>
All tests pass. Tests cover OS detection with mocked values, install hint lookups for multiple OS types, and graceful fallbacks.
  </done>
</task>

</tasks>

<verification>
```bash
# Run unit tests
pytest tests/unit/test_environment.py -v

# Quick integration test
python -c "from mlpstorage.environment import detect_os, get_install_instruction; info = detect_os(); print(f'OS: {info.system}, Distro: {info.distro_id}'); print(f'MPI install: {get_install_instruction(\"mpi\", info)}')"
```
</verification>

<success_criteria>
1. `mlpstorage/environment/` module exists with os_detect.py and install_hints.py
2. `detect_os()` returns valid OSInfo on current system
3. `get_install_instruction()` returns OS-specific commands for mpi, ssh, dlio
4. All unit tests pass (pytest tests/unit/test_environment.py)
5. Module gracefully handles missing distro package
</success_criteria>

<output>
After completion, create `.planning/phases/02-environment-validation-fail-fast/02-01-SUMMARY.md`
</output>
