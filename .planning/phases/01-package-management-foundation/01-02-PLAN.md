---
phase: 01-package-management-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Default pip install does not pull torch-cuda or nvidia packages"
    - "Installing with [full] extra still works and includes DLIO"
    - "uv can resolve dependencies using CPU-only PyTorch index"
  artifacts:
    - path: "pyproject.toml"
      provides: "CPU-only package configuration with uv index settings"
      contains: "tool.uv.index"
  key_links:
    - from: "pyproject.toml"
      to: "https://download.pytorch.org/whl/cpu"
      via: "uv index configuration"
      pattern: "download.pytorch.org/whl/cpu"
---

<objective>
Configure pyproject.toml for CPU-only default installation by adding uv index configuration for PyTorch CPU wheels.

Purpose: Ensure users installing mlpstorage do not accidentally pull GPU dependencies (torch-cuda, nvidia-*), which are not needed for this storage benchmark and add significant download/install time.

Output: Updated pyproject.toml with `[tool.uv.index]` and `[tool.uv.sources]` sections directing PyTorch to use CPU-only wheels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-package-management-foundation/01-RESEARCH.md

# Current pyproject.toml
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add uv CPU-only index configuration</name>
  <files>pyproject.toml</files>
  <action>
Add uv configuration sections to pyproject.toml to direct PyTorch packages to CPU-only index.

Add these sections AFTER the existing `[tool.coverage.report]` section:

```toml
# =============================================================================
# UV Configuration for CPU-only builds
# =============================================================================
# MLPerf Storage is a storage benchmark and does not require GPU support.
# These settings ensure CPU-only PyTorch wheels are used, avoiding large
# CUDA downloads and nvidia-* package dependencies.

[[tool.uv.index]]
name = "pytorch-cpu"
url = "https://download.pytorch.org/whl/cpu"
explicit = true

[tool.uv.sources]
torch = [{ index = "pytorch-cpu" }]
torchvision = [{ index = "pytorch-cpu" }]
torchaudio = [{ index = "pytorch-cpu" }]
```

Also add a comment in the `[project.optional-dependencies]` section explaining that the `full` extra includes DLIO which has PyTorch as a transitive dependency, but CPU-only versions will be used.

Update the comment before `full = [...]`:
```toml
# Full installation with DLIO for running benchmarks.
# Note: DLIO depends on PyTorch. The [tool.uv] configuration ensures
# CPU-only PyTorch wheels are used to avoid GPU dependencies.
full = [
    "dlio-benchmark @ git+https://github.com/argonne-lcf/dlio_benchmark.git@mlperf_storage_v2.0",
]
```
  </action>
  <verify>
Run: `grep -A2 "tool.uv.index" pyproject.toml` to confirm index configuration exists.
Run: `grep "pytorch-cpu" pyproject.toml` to confirm CPU index URL is present.
  </verify>
  <done>
pyproject.toml contains `[[tool.uv.index]]` with pytorch-cpu URL and `[tool.uv.sources]` directing torch packages to CPU index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add packaging dependency for version parsing</name>
  <files>pyproject.toml</files>
  <action>
Add `packaging` to the core dependencies in pyproject.toml. This library is needed by the lockfile validator to parse and compare version strings correctly (PEP 440 compliant).

Update the `dependencies` list in `[project]`:
```toml
dependencies = [
    "psutil>=5.9",
    "pyarrow",
    "pyyaml>=6.0",
    "packaging>=21.0",  # For PEP 440 version parsing in lockfile validation
]
```

The `packaging` library is the official PyPA library for version parsing and is a very lightweight dependency (pure Python, no transitive deps).
  </action>
  <verify>
Run: `grep "packaging" pyproject.toml` to confirm packaging is in dependencies.
Run: `python -c "from packaging.version import Version; print(Version('1.0.0'))"` to verify packaging works (should already be installed as pip dependency).
  </verify>
  <done>
`packaging>=21.0` is listed in project dependencies. Version parsing will be available for lockfile validation.
  </done>
</task>

</tasks>

<verification>
- [ ] pyproject.toml contains `[[tool.uv.index]]` section with pytorch-cpu URL
- [ ] pyproject.toml contains `[tool.uv.sources]` directing torch to CPU index
- [ ] `packaging>=21.0` is in the dependencies list
- [ ] File is valid TOML (no syntax errors)
- [ ] Existing test/full/dlio extras are unchanged in functionality
</verification>

<success_criteria>
1. `uv pip compile pyproject.toml` would resolve PyTorch to CPU-only wheels
2. `packaging` library is available for version comparison
3. Default install (`pip install .`) does not change in behavior
4. [full] extra still installs DLIO correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-package-management-foundation/01-02-SUMMARY.md`
</output>
