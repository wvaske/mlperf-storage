---
phase: 03-kv-cache-benchmark-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mlpstorage/cli/kvcache_args.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can specify --hosts argument for multi-host execution"
    - "User can specify --exec-type to choose MPI or local execution"
    - "User can specify MPI options (--mpi-bin, --oversubscribe, --allow-run-as-root)"
    - "User can specify --num-processes for MPI rank count"
  artifacts:
    - path: "mlpstorage/cli/kvcache_args.py"
      provides: "Distributed execution CLI arguments for KV cache"
      contains: "add_host_arguments"
  key_links:
    - from: "mlpstorage/cli/kvcache_args.py"
      to: "mlpstorage/cli/common_args.py"
      via: "import add_host_arguments, add_mpi_arguments"
      pattern: "from mlpstorage.cli.common_args import.*add_host_arguments.*add_mpi_arguments"
---

<objective>
Add distributed execution CLI arguments to the KV cache benchmark.

Purpose: Enable users to run KV cache benchmarks across multiple hosts using MPI, following the same patterns as training and checkpointing benchmarks.

Output: Updated kvcache_args.py with --hosts, --exec-type, --num-processes, and MPI arguments available on the `run` command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-kv-cache-benchmark-integration/03-RESEARCH.md

# Reference for argument patterns:
@mlpstorage/cli/training_args.py
@mlpstorage/cli/common_args.py
@mlpstorage/cli/kvcache_args.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add distributed execution arguments to KV cache CLI</name>
  <files>mlpstorage/cli/kvcache_args.py</files>
  <action>
  Modify kvcache_args.py to add distributed execution arguments to the `run` command:

  1. Add imports at top:
     - Import `add_host_arguments` and `add_mpi_arguments` from common_args
     - Import `EXEC_TYPE` from mlpstorage.config

  2. Add helper function `_add_kvcache_distributed_arguments(parser)`:
     - Add `--exec-type` argument with choices from EXEC_TYPE enum, default EXEC_TYPE.MPI
     - Add `--num-processes` argument (int, help about MPI rank count)
     - Call `add_host_arguments(parser)` to add --hosts
     - Call `add_mpi_arguments(parser)` to add --mpi-bin, --oversubscribe, --allow-run-as-root, --mpi-params

  3. In `add_kvcache_arguments()`, call `_add_kvcache_distributed_arguments(run_benchmark)` after existing argument additions

  Follow the pattern from training_args.py lines 46-72 for argument structure.

  Do NOT modify the datasize command - it doesn't need distributed execution.
  </action>
  <verify>
  Run: `python -c "from mlpstorage.cli.kvcache_args import add_kvcache_arguments; import argparse; p = argparse.ArgumentParser(); sp = p.add_subparsers(); kv = sp.add_parser('kv'); add_kvcache_arguments(kv); print('OK')"`

  Then verify arguments exist:
  `mlpstorage kvcache run --help | grep -E "(hosts|exec-type|num-processes|mpi-bin)"`
  </verify>
  <done>
  - `mlpstorage kvcache run --help` shows --hosts, --exec-type, --num-processes, --mpi-bin arguments
  - --exec-type defaults to MPI
  - --hosts accepts space-separated hostnames
  - MPI arguments (--oversubscribe, --allow-run-as-root, --mpi-params) are available
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for KV cache CLI arguments</name>
  <files>tests/unit/test_cli_kvcache.py</files>
  <action>
  Create new test file tests/unit/test_cli_kvcache.py with tests for the new CLI arguments:

  ```python
  """Tests for KV Cache CLI argument parsing."""
  import pytest
  from argparse import ArgumentParser
  from mlpstorage.cli.kvcache_args import add_kvcache_arguments
  from mlpstorage.config import EXEC_TYPE


  class TestKVCacheDistributedArgs:
      """Test distributed execution arguments for KV cache CLI."""

      @pytest.fixture
      def parser(self):
          """Create parser with kvcache subcommand."""
          parser = ArgumentParser()
          subparsers = parser.add_subparsers(dest="program")
          kvcache_parser = subparsers.add_parser("kvcache")
          add_kvcache_arguments(kvcache_parser)
          return parser

      def test_hosts_argument_exists(self, parser):
          """Verify --hosts argument is available on run command."""
          args = parser.parse_args(["kvcache", "run", "--hosts", "host1", "host2"])
          assert args.hosts == ["host1", "host2"]

      def test_exec_type_default_is_mpi(self, parser):
          """Verify --exec-type defaults to MPI."""
          args = parser.parse_args(["kvcache", "run"])
          assert args.exec_type == EXEC_TYPE.MPI

      def test_exec_type_can_be_set(self, parser):
          """Verify --exec-type can be explicitly set."""
          args = parser.parse_args(["kvcache", "run", "--exec-type", "mpi"])
          assert args.exec_type == EXEC_TYPE.MPI

      def test_num_processes_argument(self, parser):
          """Verify --num-processes accepts integer value."""
          args = parser.parse_args(["kvcache", "run", "--num-processes", "8"])
          assert args.num_processes == 8

      def test_mpi_bin_argument(self, parser):
          """Verify --mpi-bin argument works."""
          args = parser.parse_args(["kvcache", "run", "--mpi-bin", "mpiexec"])
          assert args.mpi_bin == "mpiexec"

      def test_mpi_flags(self, parser):
          """Verify MPI flags are available."""
          args = parser.parse_args([
              "kvcache", "run",
              "--oversubscribe",
              "--allow-run-as-root"
          ])
          assert args.oversubscribe is True
          assert args.allow_run_as_root is True

      def test_datasize_does_not_have_hosts(self, parser):
          """Verify datasize command doesn't require hosts (local-only)."""
          # datasize should work without hosts
          args = parser.parse_args(["kvcache", "datasize"])
          # Should not have hosts attribute or should have default
          assert not hasattr(args, 'hosts') or args.hosts is None or args.hosts == ["localhost"]
  ```
  </action>
  <verify>
  Run: `pytest tests/unit/test_cli_kvcache.py -v`
  All tests should pass.
  </verify>
  <done>
  - 8 tests pass covering all new CLI arguments
  - Tests verify --hosts, --exec-type, --num-processes, --mpi-bin, --oversubscribe, --allow-run-as-root
  - Tests confirm datasize command doesn't require distributed args
  </done>
</task>

</tasks>

<verification>
1. `mlpstorage kvcache run --help` shows all new arguments:
   - --hosts (in its own group or Host Configuration)
   - --exec-type (with MPI as default)
   - --num-processes
   - MPI group with --mpi-bin, --oversubscribe, --allow-run-as-root, --mpi-params

2. `mlpstorage kvcache datasize --help` works without distributed args

3. All unit tests pass: `pytest tests/unit/test_cli_kvcache.py -v`
</verification>

<success_criteria>
- KV cache run command accepts --hosts, --exec-type, --num-processes, and MPI arguments
- Arguments follow same patterns as training benchmark
- Unit tests verify argument parsing works correctly
- No regression in existing kvcache functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-kv-cache-benchmark-integration/03-01-SUMMARY.md`
</output>
